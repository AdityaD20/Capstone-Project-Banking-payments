<div class="container-fluid pt-4">
  <h3 class="mb-4">Transaction Reports</h3>

  <!-- Filter and Download Card -->
  <div class="card mb-4">
    <div class="card-body">
      <form [formGroup]="filterForm" (ngSubmit)="generateReport()">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="from" class="form-label">From</label>
            <input type="date" id="from" class="form-control" formControlName="from">
          </div>
          <div class="col-md-3">
            <label for="to" class="form-label">To</label>
            <input type="date" id="to" class="form-control" formControlName="to">
          </div>
          <div class="col-md-3">
            <label for="type" class="form-label">Payment Type</label>
            <select id="type" class="form-select" formControlName="type">
              <option value="">All</option>
              <option value="SALARY">Salary</option>
              <option value="VENDOR">Vendor</option>
            </select>
          </div>
          <div class="col-md-3 d-flex gap-2">
            <!-- Button is now disabled if the form is invalid, which includes our custom validator -->
            <button type="submit" class="btn btn-primary w-100" [disabled]="isLoading || filterForm.invalid">Generate</button>
          </div>
        </div>

        <!-- ADDED: Error message for the custom validator -->
        <div *ngIf="filterForm.errors?.['dateRangeInvalid'] && filterForm.touched" class="text-danger small mt-2">
          The 'From' date cannot be after the 'To' date.
        </div>
      </form>
    </div>
  </div>

  <!-- Report Results Card -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      Report Results
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-danger" (click)="download('pdf')" [disabled]="isDownloadingPdf || reportData.length === 0">
          <span *ngIf="isDownloadingPdf" class="spinner-border spinner-border-sm me-1"></span>
          Download PDF
        </button>
        <button class="btn btn-sm btn-outline-success" (click)="download('excel')" [disabled]="isDownloadingExcel || reportData.length === 0">
          <span *ngIf="isDownloadingExcel" class="spinner-border spinner-border-sm me-1"></span>
          Download Excel
        </button>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="isLoading" class="text-center p-4">
        <div class="spinner-border"></div><p class="mt-2">Generating report...</p>
      </div>
      <div *ngIf="errorMessage && !isLoading" class="alert alert-danger">{{ errorMessage }}</div>

      <div *ngIf="!isLoading && !errorMessage">
        <div *ngIf="reportData.length > 0; else noResults" class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th><th>Type</th><th>Recipient/Desc</th><th>Amount</th><th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of reportData">
                <td>{{ item.transactionDate | date:'short' }}</td>
                <td><span class="badge" [ngClass]="item.type === 'SALARY' ? 'text-bg-info' : 'text-bg-warning'">{{ item.type | titlecase }}</span></td>
                <td>
                  <strong>{{ item.recipientName }}</strong><br>
                  <small class="text-muted">{{ item.description }}</small>
                </td>
                <td class="text-end">{{ item.amount | number:'1.2-2' }}</td>
                <td>
                  <span class="badge" [ngClass]="{
                    'text-bg-success': item.status === 'PAID',
                    'text-bg-secondary': item.status === 'PENDING',
                    'text-bg-danger': item.status === 'REJECTED' || item.status === 'FAILED'
                  }">{{ item.status | titlecase }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noResults><p class="text-muted p-3">No transactions found for the selected criteria. Click "Generate" to run a report.</p></ng-template>

        <!-- Pagination Controls -->
        <nav *ngIf="totalPages > 1" class="d-flex justify-content-end pt-3">
          <ul class="pagination">
            <li class="page-item" [class.disabled]="currentPage === 0">
              <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage - 1)">&laquo;</a>
            </li>
            <li class="page-item active">
              <a class="page-link" href="javascript:void(0)">{{ currentPage + 1 }}</a>
            </li>
            <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
              <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage + 1)">&raquo;</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>